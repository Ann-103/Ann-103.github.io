<!--head 和 body 是 html 的直接子元素--><!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>区块链技术基础 | Ann-Blog</title><meta name="author" content="Ann"><meta name="copyright" content="Ann"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="区块链技术基础 学习区块链的笔记，可以说是入门的基础知识，较多个人理解内容，如有错误，欢迎指正QAQ。 前言 本部分先简单介绍一下对区块链的直观理解，偏科普性质，需要一定密码学基础。 一句话总结：区块链本质上是一个分布式的数据库（数据账本）。   区块链起源于加密数字货币，所以账本、交易等是区块链常用词汇，这里的交易可以理解成货币转移记录。而在数字货币之外的应用中，交易可以广义理解为需要记录的最小">
<meta property="og:type" content="article">
<meta property="og:title" content="区块链技术基础">
<meta property="og:url" content="https://ann-103.github.io/post/3643155828.html">
<meta property="og:site_name" content="Ann-Blog">
<meta property="og:description" content="区块链技术基础 学习区块链的笔记，可以说是入门的基础知识，较多个人理解内容，如有错误，欢迎指正QAQ。 前言 本部分先简单介绍一下对区块链的直观理解，偏科普性质，需要一定密码学基础。 一句话总结：区块链本质上是一个分布式的数据库（数据账本）。   区块链起源于加密数字货币，所以账本、交易等是区块链常用词汇，这里的交易可以理解成货币转移记录。而在数字货币之外的应用中，交易可以广义理解为需要记录的最小">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/11/14/OsgaF7GIC1NRlhe.jpg">
<meta property="article:published_time" content="2024-10-25T02:52:20.000Z">
<meta property="article:modified_time" content="2024-12-02T08:31:38.011Z">
<meta property="article:author" content="Ann">
<meta property="article:tag" content="Blockchain">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2024/11/14/OsgaF7GIC1NRlhe.jpg"><link rel="shortcut icon" href="https://s2.loli.net/2022/11/06/lgYVqNypjRCe3d2.png"><link rel="canonical" href="https://ann-103.github.io/post/3643155828.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"TYQ16Q4ESJ","apiKey":"ea175434f2803b60c631bc11c6e24e54","indexName":"blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":200,"languages":{"author":"作者: Ann","link":"链接: ","source":"来源: Ann-Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '区块链技术基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-12-02 16:31:38'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/essay_page/essay_page.css"><link rel="stylesheet" href="/css/hot.css"><meta name="generator" content="Hexo 7.3.0"><link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="scarecrow"><div class="scarecrow__hat"><div class="scarecrow__ribbon"></div></div><div class="scarecrow__head"><div class="scarecrow__eye"></div><div class="scarecrow__eye"></div><div class="scarecrow__mouth"></div><div class="scarecrow__pipe"></div></div><div class="scarecrow__body"><div class="scarecrow__glove scarecrow__glove--l"></div><div class="scarecrow__sleeve scarecrow__sleeve--l"></div><div class="scarecrow__bow"></div><div class="scarecrow__shirt"></div><div class="scarecrow__coat"></div><div class="scarecrow__waistcoat"></div><div class="scarecrow__sleeve scarecrow__sleeve--r"></div><div class="scarecrow__glove scarecrow__glove--r"></div><div class="scarecrow__coattails"></div><div class="scarecrow__pants"></div></div><div class="scarecrow__arms"></div><div class="scarecrow__leg">  </div></div></div><script async="async">(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })
  document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})
  setTimeout(function(){preloader.endLoading();}, 10000);

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">28</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i><span> About</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw iconfont icon-paper-full"></i><span> 关于</span></a></li><li><a class="site-page child" href="/essay/"><i class="fa-fw iconfont icon-shuoshuo"></i><span> 动态</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Ann-Blog"><span class="site-name">Ann-Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i><span> About</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw iconfont icon-paper-full"></i><span> 关于</span></a></li><li><a class="site-page child" href="/essay/"><i class="fa-fw iconfont icon-shuoshuo"></i><span> 动态</span></a></li></ul></div></div></div><div id="rightBank"><div id="box"> <a href="/link" title="百宝箱"><i class="iconfont icon-24gf-box2"></i></a></div><div id="random"><a class="site-page" href="javascript:toRandomPost()" title="随机前往一个文章"><i class="iconfont icon-touzi"> </i></a></div><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">区块链技术基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-25T02:52:20.000Z" title="发表于 2024-10-25 10:52:20">2024-10-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-12-02T08:31:38.011Z" title="更新于 2024-12-02 16:31:38">2024-12-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Blockchain/">Blockchain</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>45分钟</span></span></div></div></div><div class="top-img gist" style="background-image: url(/false)"></div><article class="post-content" id="article-container"><h1 id="区块链技术基础">区块链技术基础</h1>
<p>学习区块链的笔记，可以说是入门的基础知识，较多个人理解内容，如有错误，欢迎指正QAQ。</p>
<h2 id="前言">前言</h2>
<p>本部分先简单介绍一下对区块链的直观理解，偏科普性质，需要一定密码学基础。</p>
<div class="note success flat"><p>一句话总结：<strong>区块链本质上是一个分布式的数据库</strong>（数据账本）。</p>
</div>
<blockquote>
<p>区块链起源于加密数字货币，所以<strong>账本、交易</strong>等是区块链常用词汇，这里的交易可以理解成货币转移记录。而在数字货币之外的应用中，交易可以广义理解为需要记录的最小数据单元，多条交易会被打包成区块一起写入区块链中。</p>
</blockquote>
<h3 id="分布式">分布式</h3>
<div class="note info flat"><p>区块链第一大特性：分布式信任</p>
</div>
<p>首先介绍一下分布式的概念，以账目管理为例：</p>
<ul>
<li><strong>中心化管账</strong>：专员在公告板上贴了账本，其余人去查公告板并信任这是正确的版本，此时专员可以作假账目。</li>
<li><strong>分布式管账</strong>：人手一个账本，没有范本，而是通过<strong>相互传阅</strong>来更新自己手里的账本。</li>
</ul>
<p>在分布式管账中，<strong>人手一份的账本</strong>不需要担心中心专员作假，但每个人都有了作假的动机和机会，例如将自己曾经的欠债记录划去，然后对别人声称自己这份才是真的。此时系统中可能会存在多份不同的真假账本，无法确认从某个人手中传阅得到的账本是正确的。</p>
<p>直观上来说，我们可以通过对比所有人的账本，然后以少数服从多数的原则防止少数人作恶，但这个办法并不具有实际可操作性。</p>
<blockquote>
<p>虽然少数服从多数的思想是正确且核心的，但如何判断哪部分人是多数？难道要从村头跑到村尾一个个对比账本确认？那在你耗时耗力对比的过程中，可能又有了新的账目要记录，有了新的正确版本……</p>
<p>核心问题：并没有公开可验证的方式让每个人都能高效判断账本的正确性。</p>
</blockquote>
<p>一个朴素的解决方案是：选用特殊的账本结构保证历史记录难以篡改，比如每一页会记录前一页的<strong>哈希值</strong>，那任何人想要更改前面的记录都是不可能的，因为会和下一页的哈希值对不上，也就得不到其他人的认可，不会广泛传播，这也就引出了区块链的又一特性：</p>
<div class="note info flat"><p>区块链第二大特性：不可篡改</p>
</div>
<p>通过特殊的账本结构，我们保证了已有的账本记录不会被轻易篡改，但还是没有解决如何添加新的账本记录的问题，所有人都可以往自己的账目上添加一笔交易，然后和其他人说这是正确的。</p>
<p>事实上，分布式系统缺少了中心化系统中对交易进行审核的人员，这意味着我们希望大家一起审核某个交易，在多数人觉得这是正确的时候向各自的账本添加该交易。或者更具体的说，由于并不存在”公告“，应该是由某个人添加交易，其他人抄录这个人的账本。这里对应了如何让所有人达成共识。</p>
<blockquote>
<p>分布式就是权利均摊，考虑少数人恶意，并且系统会消解掉少数人的恶意行为。</p>
</blockquote>
<h3 id="共识达成">共识达成</h3>
<p>首先，从效率上来看，将<strong>多条交易打包成区块</strong>一起共识记账是有必要的。</p>
<p>在此基础上，以时间为单位，某个时刻的记账者应当是<strong>受认可且唯一</strong>的（记账权），否则根据打包结果的不同可能会有交易正确但是顺序不正确的多个版本。这就引出了两个问题：1. 记账的人需要有奖励制度，否则没人想干活。2.记账权需要该时刻所有人都认可：</p>
<ol>
<li>
<p><strong>奖励制度</strong>很简单，我们只需要给记账者一定酬劳，例如比特币的挖矿奖励和记账奖励。</p>
</li>
<li>
<p><strong>记账权</strong>则依赖于共识机制，这里可以简单理解为根据规则进行“竞赛”，胜者获得其他人的认可。</p>
</li>
</ol>
<p>有关如何实现共识机制，后面会有更详细的介绍。</p>
<h3 id="其他问题">其他问题</h3>
<p>至此，已经可以保证大家手中已有的账本不会被篡改，交易账目被所有人审核，然后某个记账者获得记账权记录新的账目并给大家传阅，之后会有新的记账者进行账目记录，但我们仍然能够发现一些需要关注的BUG，比如：</p>
<ol>
<li>矿工的私心：矿工A获得记账权时觉得修改交易1的数据有利于自己，于是仗着自己能记账就记录了错误的交易。</li>
<li>多个矿工同时“胜利”，同一时刻有多个正确版本。</li>
<li>…</li>
</ol>
<p>这些问题对应有自己的解决方案或者机制，这里仅做简单介绍：</p>
<ol>
<li>加密和签名：利用<strong>密码学方法</strong>让交易1的发起者自己对交易内容加密和签名，其余人都可以验证该条交易是否被修改过。</li>
<li>区块链中仅承认“最长账本”。</li>
<li>…</li>
</ol>
<p>通过对分布式网络、共识机制、密码学等技术的集成，区块链系统构建了<strong>分布式信任</strong>的环境。进一步结合数据结构设计和共识逻辑设计，可以在区块链上部署图灵完备的编程语言，即支持在区块链上发布<strong>智能合约</strong>以及分布式应用的开发（后续介绍），进而展现出区块链的另一特性：</p>
<div class="note info flat"><p>区块链的第三大特性：<strong>不可干预执行</strong>。</p>
</div>
<p>总结而言，相较于人工智能和大数据等技术对于生产力和生产资料的改变，区块链技术对应的是<strong>生产关系的变革</strong>，具有<strong>分布式信任、不可篡改、不可干预执行</strong>三大特性。而区块链对市场信任关系的重构，可以说是彻底颠覆了以往的规则，人们可以不再依赖第三方实现资产/信用的传递。自此，从根本上解决了第三方高额手续费、交易延迟、信用破产、篡改和泄露隐私等一系列集中式架构所面临的问题。</p>
<h2 id="比特币">比特币</h2>
<p>前一节主要是对区块链的一个定性的简单了解，本节将以比特币为例具体介绍区块链的工作流程和基本原理。</p>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/bitcoinbook/bitcoinbook">GitHub - bitcoinbook/bitcoinbook: Mastering Bitcoin 3rd Edition - Programming the Open Blockchain</a></p>
<p>区块链和比特币的关系可以理解为：区块链技术起源于比特币，是对其所使用的密码学、分布式网络、共识算法等的集成创新，并随着技术的发展在加密货币以外也具有很高的应用价值。</p>
</blockquote>
<h3 id="起源">起源</h3>
<ul>
<li>比特币的概念由中本聪（Satoshi Nakamoto） 首先提出的， 迄今为止， 中本聪仍是一个网络虚拟的人物， 其真实身份还不为人知。 2008年11月1日， 中本聪在“<a target="_blank" rel="noopener" href="http://metzdowd.com">metzdowd.com</a>” 网站的密码学邮件列表中发表了一篇论文， 题为《比特币：一种点对点式的电子现金系统》 ， 中本聪首次基于区块链技术描述了一个去中心化的电子交易体系， 并提出了一种P2P形式的虚拟的加密数字货币—比特币。</li>
<li>2009年1月3日， 中本聪开发出首个实现了比特币算法的客户端程序， 并将其运行于网络， 首次“挖矿” （Mining） 获得了第一区块中第一个交易的50个比特币， 第一个区块也被称为创世区块。 标志着比特币金融体系的正式诞生。</li>
</ul>
<h3 id="区块结构">区块结构</h3>
<p>区块链的数据存储结构类似于链表，是一串以时间为顺序的连接起来的区块，区块分为区块体和区块头。</p>
<blockquote>
<p>第一个区块也称为创世区块，是人为设置的。</p>
</blockquote>
<ul>
<li>区块头：时间戳、默克尔哈希树根、上一区块的Hash等。</li>
<li>区块体：多条交易记录，交易记录根据具体应用可以分为转账记录、智能合约记录、物联网数据等。多条交易按照Merkle Hash Tree的结构组织起来。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241012111155684.png" alt="image-20241012111155684"></p>
<p><strong>Merkle Hash Tree</strong>：如图所示的组织交易的格式，叶子节点存储交易或者其哈希值。逐层向上的结构保证了所有交易记录不被篡改，这里的第一条交易一般为挖矿奖励交易，即Coinbase交易。</p>
<blockquote>
<p>Coinbase交易和区块链激励机制有关，比特币的区块激励是一个基于区块高度计算的值，初始的区块奖励值为50比特币，每210,000区块就减半（按照平均10min/块，大约4年）  ，目前比特币经历了三次减半，区块奖励为6.25BTC  ，在693万个区块后这个奖励就归零，之后区块中矿工的奖励只有手续费  。</p>
</blockquote>
<p>在不可篡改的同时，通过Merkle Tree，节点可以通过交易树根节点来快速验证一个交易是否存在于区块中，只要附上区块交易树的<strong>部分中间节点</strong>，即简单支付验证（Simplified Payment Verification，SPV）。</p>
<p>SPV<strong>验证路径</strong>为该交易所属叶子结点到MHT根节点路径上<strong>每个节点在二叉树上的兄弟节点</strong>。</p>
<h3 id="交易结构">交易结构</h3>
<p>比特币采用的是UTXO模型，其所有的交易都是转账交易，交易格式由输入、输出和签名三部分组成，输出也被称为未花费交易输出（Unspent Transaction Outputs，UTXO），并作为下一笔交易的输入。</p>
<ul>
<li>输入：交易的输入必须引用已存在的一个或多个UTXO，UTXO不可分割， 只能通过花费来生成新的UTXO  。</li>
<li>输出：交易的输出UTXO可以指向一个或多个账户并附上输出币额。这里的<strong>账户</strong>对应的是用户公钥计算得到的地址。</li>
<li>签名：拥有者用自己的私钥对输入的UTXO签名，以证明交易是由付款者本人发起的。</li>
</ul>
<p>一般来说，交易的输入总币额和输出总币额会存在<strong>差额</strong>，这部分会充作给矿工的奖励，矿工也可能会按照奖励排序选择打包交易的顺序，这么做也可以避免一些被故意制造的垃圾交易。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241012155336970.png" alt="image-20241012155336970"></p>
<p>可以看出，在UTXO模型中其实是并没有”余额“概念的，也就是说判断你是否有UTXO或者说你是否能够发起一笔转账，并不是看你账户的余额，而是看你之前是否有对应获得UTXO的交易，你甚至无法自由选择输入的UTXO的币值，而是只能<strong>用一笔交易的UTXO去启动另一笔交易</strong>。</p>
<p>对于虚拟货币来说，区块链技术的出现可以说是彻底解决了虚拟货币归属不清、易起纠纷的问题。比如，使用UTXO概念来跟踪比特币，可以使得比特币在没有第三方背书的情况下被记录转账和所属记录。利用区块链记账可以有效溯源每一笔交易的合法性，即使出现了不合法的交易，也可以通过直接舍弃该分支的方式而不影响其他任何内容，因为此时的记录单元是交易而不是计算的余额，这一点是和我们常用的支付宝等是不一样的。</p>
<blockquote>
<p>直观理解就是，每次花钱的时候，就把你之前所有的获得这笔钱的交易都检查一遍</p>
</blockquote>
<h4 id="双花问题">双花问题</h4>
<p>双花问题是虚拟货币面临的经典问题，即多次花同一笔钱：A只有一个比特币，但构造了两条使用一比特币买东西的交易1和交易2，如果其中一个交易还未确认那两个交易可能都会通过验证（还没确认相当于账户还没扣费）。</p>
<p>比特币系统中使用UTXO模型和时间戳来解决双花问题：</p>
<ul>
<li>如果俩交易被同一区块打包，确认交易1和交易2是不是用的同一个比特币，如果是则仅接受时间靠前的交易；</li>
<li>如果俩交易分别被不同区块打包，那要么一笔交易提前确定剩下一笔作废，要么同时确认产生分叉等待其一自动死亡</li>
</ul>
<h3 id="pow共识">POW共识</h3>
<p>共识机制用于确认记账权，或者说为了使得全网的账本同步。</p>
<p>比特币使用POW（工作量证明）共识机制，也就是<strong>挖矿</strong>：对于某个区块数据block data而言，所有矿工（记账者）需要通过遍历一个nonce的值，计算<code>hash(block data，nonce)</code>，直到某人计算出的值小于某个设定的难度值（提前设定），即视作挖矿成功，该矿工就可以把区块记账，然后将区块广播。</p>
<p>其他人验证了该矿工提供的nonce和哈希值，就认可了本时刻他手中的账本。</p>
<blockquote>
<p>注意：POW中每个人的block data是不同的，因为区块的第一笔交易是报酬交易，每个人都不一样，而且个人打包的交易也可能不一样，所以不会出现窃取他人工作量的结果。</p>
</blockquote>
<p>但是，这里就出现了一个问题，也就是前面提到的，如果矿工A和B在接近的时间内同时成功挖矿，并分别将自己的版本告诉了B和C且验证通过，整个系统就会在同一时刻出现两个甚至多个正确账本，即区块链的分叉。</p>
<p>其实解决方案很简单：既然<strong>传播信息的时间差</strong>在分布式系统中不可避免，那就<strong>允许同一时刻有两个或多个正确版本</strong>，后续谁收到哪个版本就在哪个版本上继续挖矿，直到一条链比其他链都要长，其他分叉自然死亡。</p>
<p>也就是说，即使某个交易已经上链，也不一定代表着它已经被确认。在比特币中，一般认为超过六个区块确认的交易一般是无法篡改的，也就是说，交易需要经过六个块的时间等待确认。</p>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241023100004179.png" alt="image-20241023100004179" style="zoom: 80%;" />
<p>可以看出，POW的承认并不是君子之约遵守规则，而是如果你不承认A挖出来的区块，还按照自己的版本挖矿，那别的矿工在A版本上挖矿的进度会比你快，比你受认可，导致你所作的都是无用功。</p>
<blockquote>
<p>一般来说，区块链产生块的时间为10min左右。</p>
</blockquote>
<p>由于POW机制以及最长链定理，在比特币中，<strong>伪造区块链需要拥有超过51%的全网算力</strong>，这个代价很大。</p>
<blockquote>
<p>从另一个角度来看，即使有人能够掌控51%的算力成为最大受益者，那么在短期获利后，由于信任系统的崩塌，他会付出更多代价，例如比特币贬值。这里也有一些博弈论的思想。</p>
</blockquote>
<h3 id="比特币网络">比特币网络</h3>
<h4 id="网络节点">网络节点</h4>
<p>比特币基于<strong>点对点（P2P）网络</strong>架构设计，网络上每个节点都是对等的（每个节点都有自己的区块链备份），但从上层应用的视角来看，根据节点提供的不同功能可以分为四类：</p>
<table>
<thead>
<tr>
<th>节点类型</th>
<th>路由</th>
<th>挖矿</th>
<th>钱包</th>
<th>全区块链账本</th>
</tr>
</thead>
<tbody>
<tr>
<td>比特币核心（Bitcoin Core）节点</td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
</tr>
<tr>
<td>普通全（Full Node）节点</td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
<td></td>
<td></td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
</tr>
<tr>
<td>独立挖矿（Solo Miner）节点</td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
<td></td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
</tr>
<tr>
<td>轻量级钱包（Lightweight Wallet）节点</td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
<td></td>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">✓</mi></mrow><annotation encoding="application/x-tex">\checkmark</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69224em;vertical-align:0em;"></span><span class="mord amsrm">✓</span></span></span></span></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>路由：所有节点都需要通过路由功能发现并维持其他对等节点，同时参与验证与并<strong>转发交易和区块</strong>信息。</li>
<li>挖矿：记账和铸币过程，铸币可以简单理解为挖矿成功后依据规则产生的原生货币如比特币。这里可以简单理解为有记账能力，例如比特币中的有一定计算资源可以挖矿的节点。</li>
<li><strong>钱包</strong>：管理账户私钥、资产并实施交易行为。在比特币中，账户表示为某个<strong>地址</strong>，对应<strong>公钥的哈希值</strong>，可以使用基于私钥的签名进行唯一标识。</li>
<li>全区块链账本：存储完整且最新的区块链数据，使得节点能够独立验证所有交易数据。</li>
</ul>
<p>一般我们分析的主要是区块链中的<strong>全节点和轻节点</strong>：</p>
<ul>
<li>全节点：维护<strong>完整的、 最新的</strong>包含全部交易的比特币<strong>区块链</strong>副本，可以独立可信地验证任何交易 。该节点在创建之初仅包含了内置在客户端软件中的创世区，需要同步所有区块，如果中间离开了一段时间，则需要根据当前<strong>最新块高度</strong>同步缺失内容。</li>
<li>轻节点（SPV节点）：通过一种简易支付验证（SPV） 的方法使得能够在<strong>仅存储区块头</strong>（信息少1000倍）的条件下验证交易，依赖于对等节点提供的区块链数据局部视图进行验证 。</li>
</ul>
<p>这里主要解释一下轻节点，除了之前我们提到的可以封装成钱包从而存储客户端重要数据之外，轻节点还可以利用Merkle机制对<strong>交易</strong>是否存在进行验证，同样也可以验证<strong>区块</strong>是否符合POW。</p>
<blockquote>
<p>实际上，在挖矿节点中，基于挖矿服务器的节点也并没有区块链信息，而是通过服务器提供的矿池数据进行挖矿。这也是现实中很多人挖矿的方式，这里就不拓展介绍了。</p>
</blockquote>
<h4 id="中继网络-relay-network">中继网络（Relay Network）</h4>
<p>直观上，我们可以感受到区块链的这种收到信息就到处传播的网络可能是人类设计的最疯狂最低效的交流方式，丝毫不考虑被接收者是否已经获得已有数据。而比特币的POW机制又对于时间非常敏感，就像在前言中提到的那样，如果是因为网络传播时延导致竞争失败，会严重影响比特币生态的良好发展。</p>
<p><strong>快速互联网比特币传播引擎</strong>（Fast Internet Bitcoin Relay Engin，FIBRE）： 通过选择最有效的节点和路径来实现比特币交易和区块的快速传播，从而减少延迟，同时，比特币系统预置了全球固定的种子节点，固定在了比特币的核心源码中。</p>
<h4 id="节点加入与节点发现">节点加入与节点发现</h4>
<p>新节点为了加入到网络中需要发现网络中的其他节点，首先需要建立节点间的TCP连接（比特币通常以8333作为TCP服务端口），在建立节点时会发送一个包含基本版本信息的“握手消息”<strong>version</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    nVersion:       \\客户端使用的比特币P2P版本协议</span><br><span class="line">    nLocalServices: \\节点支持的本地服务列表</span><br><span class="line">    nTime： 			\\当前时间</span><br><span class="line">    addrYou： 		\\远程节点IP</span><br><span class="line">    addrMe： 		\\本地IP</span><br><span class="line">    subver： 		\\子版本信息， 用于展示本节点运行的软件类型</span><br><span class="line">    BestHeight：		\\子节点区块高度</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>双方节点通过发送version 信息，会对应地发送确认信息verack 以表示节点兼容，当双方互相确认过version信息之后，节点间的连接正式建立。</p>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241012145257239.png" alt="image-20241012145257239" style="zoom:100%;" />
<p>一个新节点可以通过“DNS种子” 方式来获取已有的比特币节点的IP地址列表。 “DNS” 种子是一个提供了比特币节点IP地址列表的DNS服务器。 DNS种子分为两类：</p>
<ol>
<li>
<p>提供稳定的比特币监听节点IP地址的静态列表</p>
</li>
<li>
<p>提供随机的比特币节点IP地址， 这些列表通过爬虫或者运行比特币客户端来得到。</p>
</li>
</ol>
<p>由于比特币网络是一个动态网络， 网络中的节点可能随时加入或者离开， 新的节点为了使自己的连接变得稳定，需要在接入到网络之后， 不断地发现新节点和被新的节点发现。 新节点可以通过Addr和Getaddr 操作来完成这一功能。</p>
<p>节点状态检测：如果一个连接上没有通信，节点会定期发送一个信息以维持这个连接。如果一个节点在一个连接上超过90分钟未通信，就认为这个节点从连接断开。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitcoin-cli getpeerinfo</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 0,</span><br><span class="line">    &quot;addr&quot;: &quot;82.64.116.5:8333&quot;,</span><br><span class="line">    &quot;addrbind&quot;: &quot;192.168.0.133:50564&quot;,</span><br><span class="line">    &quot;addrlocal&quot;: &quot;72.253.6.11:50564&quot;,</span><br><span class="line">    &quot;network&quot;: &quot;ipv4&quot;,</span><br><span class="line">    &quot;services&quot;: &quot;0000000000000409&quot;,</span><br><span class="line">    &quot;servicesnames&quot;: [</span><br><span class="line">      &quot;NETWORK&quot;,</span><br><span class="line">      &quot;WITNESS&quot;,</span><br><span class="line">      &quot;NETWORK_LIMITED&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;lastsend&quot;: 1683829947,</span><br><span class="line">    &quot;lastrecv&quot;: 1683829989,</span><br><span class="line">    &quot;last_transaction&quot;: 0,</span><br><span class="line">    &quot;last_block&quot;: 1683829989,</span><br><span class="line">    &quot;bytessent&quot;: 3558504,</span><br><span class="line">    &quot;bytesrecv&quot;: 6016081,</span><br><span class="line">    &quot;conntime&quot;: 1683647841,</span><br><span class="line">    &quot;timeoffset&quot;: 0,</span><br><span class="line">    &quot;pingtime&quot;: 0.204744,</span><br><span class="line">    &quot;minping&quot;: 0.20337,</span><br><span class="line">    &quot;version&quot;: 70016,</span><br><span class="line">    &quot;subver&quot;: &quot;/Satoshi:24.0.1/&quot;,</span><br><span class="line">    &quot;inbound&quot;: false,</span><br><span class="line">    &quot;bip152_hb_to&quot;: true,</span><br><span class="line">    &quot;bip152_hb_from&quot;: false,</span><br><span class="line">    &quot;startingheight&quot;: 788954,</span><br><span class="line">    &quot;presynced_headers&quot;: -1,</span><br><span class="line">    &quot;synced_headers&quot;: 789281,</span><br><span class="line">    &quot;synced_blocks&quot;: 789281,</span><br><span class="line">    &quot;inflight&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;relaytxes&quot;: false,</span><br><span class="line">    &quot;minfeefilter&quot;: 0.00000000,</span><br><span class="line">    &quot;addr_relay_enabled&quot;: false,</span><br><span class="line">    &quot;addr_processed&quot;: 0,</span><br><span class="line">    &quot;addr_rate_limited&quot;: 0,</span><br><span class="line">    &quot;permissions&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;bytessent_per_msg&quot;: &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;bytesrecv_per_msg&quot;: &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;connection_type&quot;: &quot;block-relay-only&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="比特币钱包">比特币钱包</h3>
<h4 id="密钥技术">密钥技术</h4>
<p>轻量级钱包节点可以封装成钱包（wallet）。广义来说这里的钱包指的是用户端的应用程序，可以控制用户<strong>资金访问权限</strong>， 管理<strong>密钥和地址</strong>， 跟踪余额以及创建和签名交易。 狭义上我们可以直接理解为是用于<strong>存储和管理用户密钥</strong>的数据结构。</p>
<p>与直观相违背的是，钱包中保存的是多个密钥，而不是所谓的比特币。这是因为前面提到的UTXO机制，用户使用签名交易的方式证明拥有某个UTXO，后续要花费这个币也需要验证前一笔交易，也就是说验证你的资产的方式并不是翻钱包，而是用钱包里的密钥去查区块链账本。</p>
<p>而比特币中的余额概念由钱包程序创建， 钱包通过扫描区块链并汇总其密钥可以控制的所有UTXO值， 来计算余额。</p>
<p>基于密钥技术，钱包可以分为：</p>
<ol>
<li>非确定性钱包（nondeterministic wallet）：密钥相互不关联，是由不同的随机数产生的，钱包丢失则密钥全部丢失。</li>
<li>确定性钱包（deterministic wallet  ）：密钥均产生于单个主密钥seed，如使用<strong>HD</strong>（hierarchical deterministic）  派生方法，可以由主密钥恢复所有密钥。</li>
</ol>
<p>我们并不鼓励使用非确定性钱包，备份和使用都很麻烦。目前大部分钱包都是用BIP-39 标准助记符来导入和导出用于备份和恢复的种子。</p>
<h4 id="地址生成">地址生成</h4>
<p>实际比特币中公私钥和地址生成的步骤如下（基于ECDSA算法）：</p>
<ol>
<li>随机选择32字节私钥k，例如<code>1E99423A4ED27608A15A2616A2B0E9E52CED330AC530EDCC32C8FFC6A526AEDD  </code></li>
<li>通过ECDSA算法生成公钥：<code>041e7bcc70c72770dbb72fea022e8a6d07f814d2ebe4de9ae3f7af75bf706902a7|b73ff919898c836396a6b0c96812c3213b99372050853bd1678da0ead14487d7</code>，或者压缩公钥：<code>031e7bcc70c72770dbb72fea022e8a6d07f814d2ebe4de9ae3f7af75bf706902a7  </code></li>
<li>对公钥进行多重哈希生成地址:
<ul>
<li><code>X1= RIPEMD-160(SHA-256(PKey))  </code>，<code>X1=453233600a96384bb8d73d400984117ac84d7e8b </code></li>
<li>对加密版公钥添加网络标识字节。比特币有两个网络：主网(0x00)和测试网(0x6F)。<code>X2= FlagByte+X1 </code>，<code>X2=00453233600a96384bb8d73d400984117ac84d7e8b</code> (主网地址)</li>
<li>添加校验值 ：<code> (SHA-256(SHA-256(X2)))</code>的前4个字节：<code>00453233600a96384bb8d73d400984117ac84d7e8b|512f43c4  </code></li>
<li>“Base58”编码后就能得到我们常见的比特币钱包地址，通常是1开头</li>
</ul>
</li>
</ol>
<blockquote>
<p>根据密码学方法，先生成私钥，再生成公钥</p>
<p>任何人都可以从区块链查询到<strong>任意公钥对应的比特币余额</strong>，但是并不知道对应的用户</p>
</blockquote>
<h4 id="脚本">脚本</h4>
<p>在刚开始介绍交易的结构时，我们提到了交易是由输入、输出、签名三部分组成，其中签名是用来证明交易是由付款人本人发起的。在实际部署中，交易的生成是通过锁定和解锁脚本实现。</p>
<p><strong>锁定脚本</strong>：一般是在交易生成<strong>输出</strong>时设置，一般包含一个公钥哈希，对应的是转账接收方的账户地址，或者说将来可使用这个UTXO的条件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DUP HASH160 &lt;PubKHash&gt; EQUALVERIFY CHECKSIG</span><br></pre></td></tr></table></figure>
<p><strong>解锁脚本</strong>：一般是在交易生成<strong>输入</strong>时设置，由钱包构造的，包含了付款者数字签名的证明以及公钥，如果公钥哈希后与锁定脚本中相同，即地址对应的公钥正确，并且私钥产生的签名能被锁定脚本中的公钥解锁 ，说明这个签名是这个UTXO的所有者签署的，花费是合法的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;sig&gt; &lt;PubK&gt;</span><br></pre></td></tr></table></figure>
<p>以下面这个交易为例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//交易示例</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line">    <span class="attr">&quot;locktime&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">&quot;vin&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span>  <span class="comment">//txid和vout标明输入的UTXO来源于哪个交易中的哪个输出</span></span><br><span class="line">        <span class="attr">&quot;txid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7957a35fe64f80d234d76d83a2a8fla0d8149a41d81de548f0a65a8a999f6fl8&quot;</span>&gt;<span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vout&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">&quot;scriptSig&quot;</span> <span class="punctuation">:</span> <span class="comment">//解锁脚本，包含由用户私钥产生的签名以及公钥 &quot;3045022100884dl42d86652a3f47ba4746ec719bbfbd040a570bldeccbb6498c75c4ae24cb02204b9-F039f-F08df09cbe9f6addac960298&quot;,</span></span><br><span class="line">        <span class="attr">&quot;sequence&quot;</span><span class="punctuation">:</span> <span class="number">4294967295</span>  </span><br><span class="line">        <span class="punctuation">&#125;</span>  </span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;vout&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span>   <span class="comment">//scriptPubKey为锁定脚本，指定了将来要花费它所需要满足的条件，通常包含一个公钥或公钥哈希，可以用来辨别这个UTXO的所有者  </span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">0.01500000</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;scriptPubKey&quot;</span><span class="punctuation">:</span><span class="string">&quot; OP_DUP OP_HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 OP_EQUALVERIFY OP_CHECKSIG&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">         &#123;</span></span><br><span class="line"><span class="string">            &quot;</span>value<span class="string">&quot;: 0.00845000,</span></span><br><span class="line"><span class="string">            &quot;</span>scriptPubKey<span class="string">&quot;:&quot;</span> OP_DUP OP_HASH160 <span class="number">7</span>f9bla7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP EQUALVERIFY OP CHECKSIG<span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以对应看到交易和脚本验证内容。</p>
<blockquote>
<p>PS：由于签名也是交易的内容， 因此签名交易是通过制作交易副本， 并使用对应输出的锁定脚本替换解锁脚本， 并做出其他相应改变， 再进行哈希的 。</p>
</blockquote>
<p><strong>补充：基于栈的脚本运行</strong></p>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241012174519412.png" alt="image-20241012174519412" style="zoom:90%;" />
<ul>
<li>将<strong>解锁脚本</strong>中的签名和公钥（拥有者地址），压入栈底</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241012174649291.png" alt="image-20241012174649291"></p>
<ul>
<li>根据锁定脚本，先对公钥进行哈希，然后压入正确的地址，两者进行对比<strong>确认公钥</strong>的正确性</li>
<li>使用公钥对签名进行验证</li>
</ul>
<h3 id="比特币工作流程">比特币工作流程</h3>
<p>通过以上学习，我们可以总结比特币的工作流程：</p>
<h4 id="交易生成">交易生成</h4>
<ol>
<li>钱包软件搜集UTXO并提供正确的解锁脚本（签名）</li>
<li>构造支付给接收者的输出</li>
<li>交易向全网广播</li>
</ol>
<h4 id="交易验证">交易验证</h4>
<ol>
<li>收到交易的节点验证数据是否为输入账户所对应的数字签名，即输入UTXO的合法性</li>
<li>交易的输入是否大于输出</li>
<li>查询当前未被使用的UTXO集合，检查输入对应的UTXO是否在其中，如果不在则判定为双重支付将交易丢弃</li>
<li>通过验证后，节点将交易继续广播</li>
</ol>
<blockquote>
<p>基于脚本的交易验证主要有三个作用：</p>
<ul>
<li>身份认证：花的钱是本人的，数字签名不可伪造</li>
<li>内容校验：数额和收款人等信息不被修改，数字签名不可篡改内容</li>
<li>交易认证：交易为本人认证的，数字签名不可抵赖</li>
</ul>
<p>此外还有一些别的验证内容:交易的语法和数据结构必须正确 ,输出值以及总量必须在规定值的范围内，签名数量 (SIGOPS) 应小于签名操作数量上限 等</p>
</blockquote>
<h4 id="区块打包">区块打包</h4>
<ol>
<li>挖矿节点创造一笔特殊的交易Coinbase， 作为区块中的第一笔交易  ，即对矿工的奖励，该奖励包含区块奖励和该区块中所有交易的交易费用之和</li>
<li>完成POW的矿工将新的区块广播，收到区块的节点验证交易和区块的合法性</li>
<li>一般等待6个区块后，认为交易被确认</li>
</ol>
<h2 id="以太坊">以太坊</h2>
<p>以太坊对区块链功能进行了扩展，使之支持<strong>智能合约</strong>的应用。智能合约的出现使得区块链技术从货币交易的简单脚本应用，延伸到了<strong>图灵完备的通用计算领域</strong>。</p>
<blockquote>
<p>图灵完备：简单理解为加减乘除都支持。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://ethereumdocch.readthedocs.io/zh/latest/introduction/index.html">以太坊社区中文文档</a></p>
</blockquote>
<p>其中，智能合约是以太坊的核心概念，即以计算机程序方式运行合约。</p>
<p>智能合约由<strong>代码</strong>和<strong>数据</strong>组成，代码以特定二进制格式部署到区块链中，数据则涉及余额和合约变量。</p>
<p>在以太坊中，智能合约在以太坊虚拟机（Ethereum Virtual Machine，EVM）中运行，可以接受来自外部交易的请求而触发。</p>
<blockquote>
<p>相较于比特币这种单纯记录转账的结构，以太坊的架构要更加复杂，后续会先介绍以太坊的模型，然后再介绍区块和交易等。</p>
</blockquote>
<h3 id="起源">起源</h3>
<ul>
<li>2013年， Vitalik Buterin有了以太坊概念， 认为应该为比特币开发一个脚本编程语言， 让比特币区块链可以进行应用开发。但是， 他的想法无法得到比特币社区的认可。 随后他发布了一份白皮书形式的论文《以太坊：下一代智能合约和去中心化应用平台》 。 详细分析了比特币系统的设计、 优点和不足后， 提出要建立一条新的区块链， 一种能够被重编程用以实现任意复杂计算功能的单一区块链。 使之成为去中心化应用的平台。</li>
<li>2014年， 在多伦多大学上学八个月后， V在拿到Facebook早期投资人彼得·蒂尔鼓励辍学创业的10万元蒂尔奖学金后， 开始全职开发以太坊项目， 从此开创一段传奇。 以太坊基金会成立， Vitalik、 Gavin Wood和Jeffrey Wilcke创建了以太坊项目， 作为下一代区块链系统。 以太坊是一个有智能合约功能的公共区块链平台。 以太坊类比操作系统， 智能合约类比应用。</li>
<li>从2013年的白皮书开始， 以太坊项目经过了4年多的发展， 并最终在2017年大爆发：基于它的通证数量暴涨， 以太坊自己的燃料货币“以太币” 价格在一年的时间里最高涨了170多倍， 从2017年初的8美元到年底的接近1400美元。</li>
</ul>
<blockquote>
<p>以太坊是被黑客入侵过的，也因此有过硬分叉，也有过改进，例如2016年6月的 The DAO事件，分叉ETH和ETC，以及2017年10月，拜占庭(Byzantium)，延迟引爆难度、降低区块奖励，2019年3月，君士坦丁堡(Constantinople),优化性能、承前启后。感兴趣的可以搜索以太坊历史。</p>
</blockquote>
<h3 id="以太坊模型">以太坊模型</h3>
<p>以太坊的本质就是一个<strong>基于交易的状态机</strong>(transaction-based statemachine)。而以太坊的状态， 就是所有以太坊账户状态的集合， 所有这些账户的状态合起来， 就是以太坊的世界状态</p>
<h4 id="账户模型">账户模型</h4>
<p>与之前提到的UTXO模型不同，以太坊使用的账户模型保存了交易对账户状态的影响。可以说账户模型是更加符合普通用户的理解，即添加了“余额”的概念。</p>
<p>以太坊账户地址也是公钥哈希值，类型分为外部账户和合约账户：</p>
<ul>
<li><strong>外部账户</strong>：即普通用户用私钥控制的账户，用户可以通过外部账户向区块链中发送交易调用智能合约。</li>
<li><strong>合约账户</strong>：一种拥有合约代码的账户，它不属于任何人，也没有私钥与之对应。</li>
</ul>
<p>每个账户状态有四个属性：</p>
<ul>
<li>序号（nonce）：账户创建合约序号</li>
<li>余额（balance）：账户余额，以<code>wei</code>为单位，1 Ether=<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mn>18</mn></msup></mrow><annotation encoding="application/x-tex">10^{18}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span></span>wei</li>
<li>存储根（storageRoot）：<strong>合约账户</strong>中存储合约变量，外部账户为空</li>
<li>代码（codeHash）：<strong>合约账户</strong>存储代码Hash，外部账户为空</li>
</ul>
<h4 id="系统架构">系统架构</h4>
<p>以太坊的系统架构如下，可以看到除了我们已经知道的挖矿、交易费用、共识、P2P、区块验证等之外，以太坊的区块链中需要额外记录<strong>消息</strong>、<strong>三个树</strong>，以及通过<strong>EVM</strong>虚拟机运行智能合约。</p>
<ul>
<li>以太坊<strong>消息</strong>类似于交易  ，由合约账户产生，用于在EVM中合约账户之间的内部通信。这是一个虚拟对象，不会被记录在区块链上，主要包括：发送者、接收者、携带的以太币（value）、可选的数据域（data）、 StartGas（Gaslimit）</li>
<li>三个树：用于记录世界状态</li>
</ul>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241023111029763.png" alt="image-20241023111029763" style="zoom:100%;" />
<blockquote>
<p>一些以太坊浏览器：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://etherscan.io">etherscan</a></li>
<li><a target="_blank" rel="noopener" href="https://ethstats.net/">ethstats</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yitaifang.com/">yitaifang</a></li>
<li><a target="_blank" rel="noopener" href="http://etherchain.org/">etherchain</a></li>
</ul>
</blockquote>
<h3 id="区块结构">区块结构</h3>
<p>以太坊最早运行PoW共识，并在2022年升级到PoS共识，两种共识算法对应的区块结构略有不同。</p>
<p>与比特币的区块结构不同，以太坊不再使用MHT，而是使用MPT。</p>
<h4 id="mpt">MPT</h4>
<p><strong>默克尔前缀树</strong>（Merkle Patricia Tree，MPT）：融合了MHT和前缀树，以键值对的形式存储数据，既提供了前缀树的查询功能，又保留了MHT的验证功能。具体而言，以太坊使用MPT树保存交易、 交易的收据以及世界状态 。</p>
<blockquote>
<p>以太坊使用六进制前缀(hex-prefix, HP)编码， 使得字母表只有16个字符（一个字符称为一个nibble）</p>
</blockquote>
<table>
<thead>
<tr>
<th>节点类型</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>空节点（hashNode）</td>
<td>简单表示空</td>
</tr>
<tr>
<td>叶节点（LeafNode）</td>
<td>存储键值对</td>
</tr>
<tr>
<td>分支节点（BranchNode）</td>
<td>十六个字符选项</td>
</tr>
<tr>
<td>扩展节点（ExtensionNode）</td>
<td>压缩前缀</td>
</tr>
</tbody>
</table>
<p>举例而言：</p>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241016145609120.png" alt="image-20241016145609120" style="zoom: 50%;" />
<p>如图所示，这里的MPT存储了四个键值对，有共同前缀的使用绿色节点，使用蓝色节点选择单字符，然后紫色节点是具体数据，最上方是keccak256生成的根哈希。</p>
<h4 id="激励机制与叔块">激励机制与叔块</h4>
<p>以太坊每15秒产生一个区块，相较于比特币10分钟的区块产生时间，<strong>更容易引起区块链分叉</strong>。</p>
<p>与此同时，由于区块生成时间较短，产生分叉区块的矿工可能继续在分叉区块上挖矿，以获得更多的奖励，为了避免这种情况，以太坊设置了ghost协议来保障分叉区块矿工的权益，即对于挖出分叉块也会给予部分奖励。</p>
<p>ghost协议允许矿工在区块中包含距离当前区块6代（层）以内的分叉区块头。当区块被挖掘后，这些分叉区块的矿工将获得原始铸币奖励的2/8~7/8。此后分叉区块的矿工将更愿意回到主链上。</p>
<blockquote>
<p>区块可以引用0-2个叔块。 叔块必须是区块的前2层~前7层的祖先的直接的子块， 被引用过的叔块不能重复引用</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241023105103984.png" alt="image-20241023105103984"></p>
<p>为了实现这一机制，以太坊的区块头中会记录叔块<code>Ommers</code>的区块头,也就是父节点的兄弟（分叉）节点。</p>
<p>在以太坊中，为了避免EVM持续运行无效合约，引入了<strong>gas消耗机制</strong>，合约执行的每一步都需消耗gas，而gas最终转换为交易费支付给将交易写入到区块链上的EVM。</p>
<h4 id="区块">区块</h4>
<p>最核心的不同是区块中记录的三个MPT树以及树根：</p>
<ul>
<li>
<p>交易树（transactionRoot）：汇总交易</p>
</li>
<li>
<p>收据树（receiptsRoot）：交易类型，地址和交易结果，也就是交易收据</p>
</li>
<li>
<p>状态树（stateRoot）：汇总全局账户的状态，键表示账户地址，值为账户状态，包括序号、余额、合约代码和存储树树根。</p>
</li>
</ul>
<blockquote>
<p>有一个直观的疑问是状态树汇总了全局账户状态，可是一个区块中账户状态改变的是少数，难道要每出一个区块都要复制一整个结构吗？</p>
<p>实际上以太坊是使用LevelDB键值对数据库存储数据，这里的三个MPT树可以理解为LevelDB所存储数据的索引去帮助查询和修改。更进一步说，可以将数据库类比为账户余额，区块链类比于记账Log。</p>
</blockquote>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241016145452103.png" alt="image-20241016145452103"  />
<p>此外，可以看到区块头中有其他 一些信息，这里解释一些核心概念：</p>
<table>
<thead>
<tr>
<th>项目</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>parentHash</td>
<td>上一个区块的Hash</td>
</tr>
<tr>
<td>ommerhash</td>
<td>记录引用的叔块的Root Hash</td>
</tr>
<tr>
<td>logsBloom</td>
<td>一个Bloom Filter，用于快速查找Log</td>
</tr>
<tr>
<td>difficulty</td>
<td>挖矿难度值</td>
</tr>
<tr>
<td>number</td>
<td>区块高度，严格递增的整数</td>
</tr>
<tr>
<td>timestamp</td>
<td>区块的时间戳（秒）</td>
</tr>
<tr>
<td>gasLimit</td>
<td>当前区块限制的gas额度</td>
</tr>
<tr>
<td>gasUsed</td>
<td>当前区块交易所耗费的总gas</td>
</tr>
<tr>
<td>beneficiary</td>
<td>接收挖矿收益的账户地址</td>
</tr>
</tbody>
</table>
<p>而在区块体中除了记录交易外，还有多个叔区块头。</p>
<h3 id="交易结构">交易结构</h3>
<p>以太坊交易：由外部账户发起的，引起相关账户状态变化。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241023115213641.png" alt="image-20241023115213641"></p>
<ul>
<li>Recipient：交易接收者的地址或者合约的地址。</li>
<li>Nonce：由交易发送者EOA发出的序列号， 是账号的一个交易计数器， 用来防止重放攻击。</li>
<li>GasPrice： gas的价格（单位： wei） ， 用于计算交易费用 。</li>
<li>GasLimit：执行这笔交易所花费的最大gas数量  。</li>
<li>Value：发送给接收地址的以太币数量（单位： wei）。</li>
<li>Data：附在交易中的可变长度数据， 合约的输入数据。</li>
<li>Signature：原始EOA的ECDSA数字签名的三个组成部分（v,r,s） 。</li>
</ul>
<p><strong>交易分类</strong>如下：</p>
<table>
<thead>
<tr>
<th>交易类型</th>
<th>输入账户</th>
<th>输出账户</th>
<th>转账币额</th>
<th>输入数据</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>转账交易</td>
<td>外部账户</td>
<td>外部账户</td>
<td>value</td>
<td>-</td>
<td></td>
</tr>
<tr>
<td><strong>合约创建</strong>交易</td>
<td>外部账户</td>
<td>空</td>
<td>-</td>
<td>data</td>
<td>调用该合约的地址就可以激活区块链执行该合约</td>
</tr>
<tr>
<td><strong>合约调用</strong>交易</td>
<td>外部账户</td>
<td>合约账户</td>
<td>-</td>
<td>data</td>
<td>所有EVM都会检查交易并运行合约代码，最终全网EVM在合约执行结果上取得共识</td>
</tr>
</tbody>
</table>
<p>交易在执行过程中会消耗gas，gas会转换为以太坊币额，由交易的输入账户支付。交易需设置好输入账户所能支付的gas上限（gasLimit）以及每个gas对应的币额（gasPrice）。gasLimit × gasPrice为输入账户所能支付的最大币额，易知，该值加上value应该小于输入账户的余额。</p>
<p>为了保证交易的合法性，输入账户需要附上见证数据，即对交易的签名，根据签名可以计算出发起者账户地址。</p>
<h4 id="交易回执">交易回执</h4>
<p>以太坊区块为每一笔交易都会产生一笔回执（Recipt），表示交易的最终状态。一个回执信息主要包括：</p>
<ul>
<li>status：执行结果，1表示成功，0表示失败；</li>
<li>gasUsed：已消耗的Gas数量；</li>
<li>txHash：交易Hash；</li>
<li>logs：交易产生的日志；</li>
<li>……</li>
</ul>
<h3 id="pos共识">POS共识</h3>
<p>工作量证明（Proof of Work，PoW）在比特币中已经有过介绍，但由于依赖计算的共识机制所消耗的资源量是非常恐怖的，基于此，其他共识机制被提出。</p>
<p>以太坊的权益证明（Proof of Stake，POS）共识协议称为Casper， 采用“权益” （Stake， 即以太币） 为记账权背书。  根据矿工的权益（例如币龄、币额）来分配矿工挖矿的权力，权益越多，挖矿的概率越大。</p>
<p>大致的思路是：通过智能合约来实现，  记账权归属于“验证者” 。 任何拥有以太币的账户都可以在Casper合约中成为验证者， 前提是必须要在Casper智能合约中抵押一定的以太币（抵押的以太币越多， 被选中作为验证者的概率就越高） 。 之后Casper合约通过一种随机方式， 选出一个验证者集合。 被选中的验证者集合按照一定顺序依次验证区块（当然也可以选择放弃） ， 如果区块没有问题， 就将其添加到区块链中， 同时相应的验证者将会获得一笔与他们的抵押成比例的奖励。 如果验证者不遵守合约规定的规则， 合约就会没收他抵押的以太币作为惩罚。</p>
<p>部分PoS采用币龄的机制来规避中心化的问题，因为币龄相对于算力更难以集中控制。PoS会惩罚系统中的恶意节点，以防止它们再破坏系统，同时POS有更高的吞吐量。</p>
<h3 id="以太坊网络">以太坊网络</h3>
<p>以太坊也是基于P2P网络实现节点的动态加入和退出，并采用结构化P2P网络以支持精确查找节点地址的需求。</p>
<p>它通过分布式哈希表（Distributed Hash Table，DHT）技术实现地址结构化，它通过hash算法将地址散列为标准长度。在以太坊中，每个参与节点都有一部分地址散列表，整个网络构成一个巨大的散列表。任何接入P2P网络的节点都有位于散列表的ID，可以被其他节点精确查找。</p>
<p>并且，相较于比特币中直接将种子写入客户端源码中，以太坊还支持用户设置动态种子节点。</p>
<h3 id="以太坊钱包">以太坊钱包</h3>
<p>和比特币的钱包概念类似。</p>
<ul>
<li>钱包：管理EOA（外部账户）密钥对
<ul>
<li>私钥随机产生，用于签名用户交易。</li>
<li>钥由私钥导出，用于生成EOA地址。</li>
</ul>
</li>
<li>钱包形态
<ul>
<li>Private Key：一份随机生成的256位二进制数字。</li>
<li>Keystore &amp; Password： Mist钱包中，公私钥被password加密保存为一份JSON文件，存储在keystore子目录下；同时备份keystore和对应的password。</li>
<li>Mnemonic code： BIP 39 提案提出，目的是通过随机生成12-24个单词的助记码，单词序列通过 FBKDF2 与 HMAC-SHA512 函数创建出随机种子，该种子通过BIP-0032 提案的方式生成确定性钱包。</li>
</ul>
</li>
</ul>
<h3 id="以太坊虚拟机">以太坊虚拟机</h3>
<p>以太坊虚拟机（简称为EVM） 是以太坊协议和具体操作的核心 。EVM是一个基于栈的架构， 是以太坊中的<strong>堆栈指令解释执行器</strong>， 提供图灵完备的执行环境。 其基本数据处理单元是256位的“字”。</p>
<ul>
<li>EVM的所有指令执行必须具有确定性的输出</li>
<li>单线程</li>
<li>为了保证交易的可终止性， 引入了执行器燃料Gas  ，根据指令复杂度、内存空间对每个步骤进行计价</li>
</ul>
<p>下图是EVM的实现框架：</p>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241024114148012.png" alt="image-20241024114148012" style="zoom: 50%;" />
<h3 id="以太坊交易流程">以太坊交易流程</h3>
<p>以太坊中矿工节点收到交易后，需要验证、执行交易并将其打包进区块中。</p>
<ul>
<li>检查交易格式、签名、发起者账户余额，从发送方账户中减去相应费用并将交易转发给其他节点</li>
<li>在EVM中执行交易，根据交易类型更改账户状态、初始化合约代码、运行合约代码等，该过程会消耗gas，耗尽则异常中断且不返还（用作矿工激励），且账户状态会回滚</li>
<li>交易完成后，剩余gas会被退回输入账户</li>
<li>收集一定量的有效交易后，矿工将交易打包为新区块并进行共识</li>
<li>接收到区块的节点运行智能合约， 并对结果进行相互验证</li>
</ul>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241023114122459.png" alt="image-20241023114122459" style="zoom: 50%;" />
<blockquote>
<p>这里其实就是比比特币多了一步运行智能合约，可以理解为我在本地运行我选择的交易的智能合约并改变世界状态，如果刚好能获得记账权，那这些状态改变就生效，其他人在本地验证过后就以我为准，否则我本地运行的状态就作废，我去验证别人的区块和状态。</p>
<p>这里提到的给的gas太少导致用尽不返还其实也是为了保护矿工，毕竟基本上所有矿工都要替你运行一次，总不能好不容易有个记账权结果某个坏蛋交易跑EVM还得倒贴gas。</p>
</blockquote>
<h2 id="区块链分类">区块链分类</h2>
<p>比特币和以太坊可以说是区块链的两个经典应用，他们是允许所有人参与的，并且隐藏了所有人的身份信息，然而这样的系统也会存在一些不可避免的问题，比如比特币被用作敲诈勒索的筹码，缺少监督等。所以之后区块链逐渐衍生出了其他类别，试图在保持去中心化特质的同时，能够对参与者进行一定程度的限制。</p>
<p>根据节点间关系，可以将区块链分为三类：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>节点关系</th>
<th>中心化程度</th>
<th>介绍</th>
<th>代表</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>公有链</strong>（public chain）</td>
<td>所有节点都能读取和发送交易、参与共识</td>
<td>完全去中心化、数据公开</td>
<td>对共识、安全机制要求较高，应用最广泛的区块链</td>
<td>比特币、以太坊</td>
</tr>
<tr>
<td><strong>私有链</strong>（private chain）</td>
<td>单个机构独立维护</td>
<td>相对中心化</td>
<td>借助区块链的链式结构保障数据存储的可靠性，防止内部人员恶意篡改，所以共识机制可以简洁高效</td>
<td></td>
</tr>
<tr>
<td><strong>联盟链</strong>（Consortium Blockchains）</td>
<td>参与节点预先确定</td>
<td>权限控制介于上两者之间</td>
<td>根据策略决定数据是否可以对外公开，记账由预选节点共识确定</td>
<td>Hyperledger，FISCO BCOS</td>
</tr>
</tbody>
</table>
<h2 id="共识算法">共识算法</h2>
<p>共识算法可以说是区块链存在的根本，我们这里先简单了解一下，后续如果研究中有涉及会深入讲解。</p>
<blockquote>
<p>共识的目的是要让多数节点达成一致，一些故障节点、恶意节点、挖矿分叉节点等也是会存在不一致的。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241025110125763.png" alt="image-20241025110125763"></p>
<h3 id="pow算法">POW算法</h3>
<ol>
<li>
<p>区块链的PoW算法</p>
</li>
<li>
<p>以太坊的PoW-Ethash算法</p>
<p>使用了Dagger-Hashimoto算法的演化版本， 混合了Vitalik Buterin提出的Dagger算法和Thaddeus Dryja 的Hashimoto 算法。该算法的挖矿效率基本与CPU无关， 而与内存大小、 带宽正相关， 目的是去除专用硬件的优势， 抵抗ASIC。具体方法是利用生成数据集合DAG（有向无环图），然后在其中选择元素进行哈希，而验证者可以基于缓存计算得到指定元素位置进而快速验证。</p>
</li>
<li>
<p>Proof of Space，基于内存困难的工作量证明方法</p>
</li>
<li>
<p>基于可信执行环境的证明，例如基于经过时间量的共识机制（Proof-of-Elapsed-Time，PoET），需要依赖TEE的安全假设</p>
</li>
</ol>
<h3 id="pos算法">POS算法</h3>
<ol>
<li>以太坊的PoS-Casper  ，会惩罚恶意节点</li>
<li>可租借PoS（Leased Proof-of-Stake，LPoS）：为了防止财富集中到富人手中，允许节点出租自己的权益，权益来源更广的节点有更多的机会获取记账权</li>
<li>委托权益证明（Delegated Proof of Stake）：代表选举方式，可以简单理解为全网投票选出节点</li>
</ol>
<h3 id="基于传统分布式一致性的共识算法">基于传统分布式一致性的共识算法</h3>
<p>传统分布式策略中也有一些一致性算法，根据网络状态可以分为同步/半同步协议。</p>
<h4 id="同步共识">同步共识</h4>
<h5 id="拜占庭pbft算法">拜占庭PBFT算法</h5>
<blockquote>
<p>拜占庭将军问题：拜占庭帝国想要进攻一个强大的敌人 ，派出10军队进行分开攻击，该敌人可以抵御6军队攻击。此时10个将军要协商进攻时间，但不确定有没有内鬼，此时如何实现正确的协商？</p>
<p>我们并不能确认将军是否叛变，比如故意发出错误进攻指令，或者在本应进攻时让其他人撤退，从而使得进攻军队少于6支。</p>
</blockquote>
<p>解决问题：在系统中可能存在恶意节点或故障节点时保证一致性。（<strong>拜占庭故障</strong>）</p>
<p>口头消息（Oral Message, OM）算法（假设有m个非诚实节点），记为OM(m)，解决包含m个叛徒的拜占庭将军问题。OM(m)是一个递归程序：</p>
<p>OM(0)</p>
<ul>
<li>主节点向每个从节点发送消息</li>
<li>每个从节点接收消息，如果缺失则记为缺省值𝑣</li>
</ul>
<p>OM(m)， m&gt;0</p>
<ul>
<li>主节点向每个从节点发送消息𝑣</li>
<li>对任意从节点𝑖， 其接收的消息𝑣记为𝑣𝑖， 未接收到则𝑣𝑖记为缺省值。将其自己作为主节点运行OM(m-1)， 向剩余𝑛 - 2个从节点发送𝑣𝑖</li>
<li>对任意𝑖和j≠𝑖， 令𝑣𝑗为第(2)步OM(m-1)中从节点 𝑖 从节点 j 接收的消息，从节点采用消息majority（𝑣1， 𝑣2， ……， 𝑣𝑛-1)。</li>
</ul>
<p>下图是一个例子：</p>
<img src="assets/image-20241025112123098.png" alt="image-20241025112123098" style="zoom: 80%;" />
<p>一个朴素且直观的理解是，我需要收到至少三个节点的消息，并且这三个节点最多有一个恶意节点，这样我就可以通过少数服从多数的方法确定正确指令。所以该算法的容错率小于1/3。</p>
<p>基于以上的引例，我们可以理解PBFT算法的核心思想。</p>
<p>一般认为PBFT算法是三阶段的，假设节点总数是3f+1=N：</p>
<ol>
<li>
<p>pre-prepare</p>
<p>主节点向全网其他节点广播从交易池中选择的交易组B</p>
<blockquote>
<p>这里的<strong>主节点</strong>是通过选举方法得出的，可以结合POS等算法。</p>
</blockquote>
</li>
<li>
<p>prepare</p>
<p>副节点验证区块，并广播prepare消息（包含节点签名，以及B的哈希）</p>
<p>等待其他节点发送的消息，如果收到超过2f个消息，就认为有效</p>
</li>
<li>
<p>commit</p>
<p>确认有效后发送commit消息，超过2f个就认为在全网达成共识。</p>
</li>
</ol>
<p>这里可能会有人觉得2和3阶段有点重复了，但事实上，举个例子来说，假如主节点是恶意节点，在pre-prepare阶段向f+1个非拜占庭节点发送B，向另外f-1个非拜占庭节点发送A，剩余f个拜占庭节点向前者的k个节点发送B的确认，则该k个节点会认为B被2f+1个节点承认，但剩余节点都没有达成共识，该轮共识失败。</p>
<p>所以阶段三的存在是为了确认共识是否成功，以及可以用于发现拜占庭节点的作恶行为。</p>
<p>此外，它的通信代价是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>量级的，只能支持数量较少的节点（一般认为是几十个）同时参与共识，后续研究引入了可聚合签名算法。</p>
<h5 id="paxos算法">Paxos算法</h5>
<blockquote>
<p>希腊岛屿Paxos上的执法者在议会大厅 中表决通过法律， 并通过服务员传递纸条的方式交流信息， 每个执法者会将通过的法律记录在自己的账本（ledger） 上。 问题在于执法者和服务员都不可靠， 他们随时会因为各种事情离开议会大厅， 并随时可能有新的执法者进入议会大厅进行法律表决， 使用何种方式能够使得这个表决过程正常进行， 且通过的法律不发生矛盾</p>
</blockquote>
<p>解决问题  ：在一个可能发生消息延迟、丢失、重复的分布式系统中如何就某个值达成一致，保证不论发生以上任何异常，都不会破坏决议的一致性。（<strong>非拜占庭故障</strong>）</p>
<p>算法将分布式系统节点分为三个类型：</p>
<ul>
<li>提议者（Proposer）负责向acceptor发起提案  。</li>
<li>接受者（Acceptor）负责响应提案，对提案进行回应以表示自己是否接受提案（这个值）。每个接受者独立选择一个值（因为它可能会收到多个提案，每个提案来自不同的提案者）并将其决定发送给学习者。</li>
<li>学习者（Learner） 不参与前面的决策过程， 只从别人那里学习已经确定的、 达成一致的提案结果。</li>
</ul>
<p>如果一个提案被半数以上Acceptor接受， 它就被选定了（Chosen） ， 并由Learner负责执行选定的提案  。</p>
<p>Phase 1</p>
<ol>
<li>准备(Prepare)：一个Proposer创建一个提案(编号N)， 并向超过半数的Acceptors发送包含提案编号的Prepare(N)消息 （提案）</li>
<li>承诺(Promise)：每个Acceptor收到消息后， 检査提案的编号N是否大于它曾接受过的所有提案的编号。 如果是， 它会回应以Promise(Nx,Vx)消息， 承诺不会接受任何编号小于N的提案；否则它将不予回应。 其中Nx和Vx是它曾接受过的提案中编号最大的提案的编号与值， 如果没有接受过提案， Nx和Vx为NULL。 （投票）</li>
</ol>
<blockquote>
<p>提案Proposal由（提案id，提案值Value  ）组成，id为Proposer自行选择 ，一般要求是相互独立、 不可重复的递增序列 。我们希望，如果一个提案v被选定，那么任何Acceptor接受的编号更大的提案或者 Proposer提出的编号更大的提案 的值都要是v。</p>
<p>该阶段可以看成是一个提议加广播的过程。</p>
</blockquote>
<p>Phase 2</p>
<ul>
<li>请求接受(Accept Request)：如果Proposer<strong>收到了超过半数Acceptors的Promise消息</strong>， 它需要先找到这些消息中编号最大的提案的值Vn， 然后向这些Acceptors发送Accept(N,Vn)消息；如果所有Promise消息中Nx和Vx都为NULL， 则Proposer可以选择任意的值作为V。</li>
<li>接受(Accepted)：当Acceptor收到Accept(N,V)消息， 它首先检査是否已承诺过编号大于N的提案， 如果答案是否定的， 它就接受该提案N， 并发送Accepted（N,Vn)；否则就拒绝。</li>
</ul>
<blockquote>
<p>该阶段可以看成回收建议加统计结果再通知的过程。</p>
</blockquote>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241025113357863.png" alt="image-20241025113357863" style="zoom: 50%;" />
<p>Paxos算法堪称里程碑式的共识算法，但是理解较为困难，且可能出现活锁问题：</p>
<p>如图所示，假如S3在A3.1之前收到了S5的更大提案，就会拒绝S1，然后在接受下一个之前收到S1的更高id的提案，如此循环形成活锁。</p>
<img src="https://cdn.jsdelivr.net/gh/Ann-103/blog_img/blockchain/image-20241025121016159.png" alt="image-20241025121016159" style="zoom:50%;" />
<h5 id="raft算法">Raft算法</h5>
<p>对Paxos算法的简化和优化，规定系统在任意时刻最多只有一个提案者（称为Leader），并为此提供了安全的Leader选举和更换机制，该机制保证了被选出的Leader具有最多的日志数据，避免提案者所给出的内容是落后的。</p>
<p>Leader会定时向Follower发送心跳包证明自己存活，否则就开始新一轮选举，获得大部分节点的投票后即成为Leader，如果因为竞选人数过多失败，会进入随机冷静期。</p>
<p>Hyperledger Fabric使用的就是Raft共识。但是一般而言，区块链开发者更愿意遵循拜占庭假设而非故障假设。</p>
<h4 id="异步共识">异步共识</h4>
<blockquote>
<p>FLP定理 ：在含有多个确定性进程的异步系统中， 只要有一个进程可能发生故障， 那么就不存在协议能保证有限时间内使所有进程达成一致</p>
</blockquote>
<p>同步公式不再适用，举例而言，由于异步网络无法确定超时时间设置，之前提到的PBFT算法会失去活性。所以异步共识的核心是不依赖任何时间假设。</p>
<h5 id="honeybadgerbft协议">HoneyBadgerBFT协议</h5>
<ul>
<li>
<p>拜占庭假设</p>
</li>
<li>
<p>核心为异步公共子集（Asynchronous Common Subset，ACS）协议：由可靠广播（Reliable Broadcast，RBC）协议和异步二进制（Asynchronous Binary Agreement，ABA）协议组成</p>
<blockquote>
<p>RBC：所有非拜占庭节点都能按一致的顺序收到完全一致的消息集</p>
<p>ABA：使所有非拜占庭节点在异步网络状态下共同产生一个一致的比特串</p>
</blockquote>
</li>
<li>
<p>每个节点选择一些交易生成区块的一部分，利用ABA确定使用哪些，就可以自行计算区块了</p>
</li>
</ul>
<h5 id="dumbo协议">Dumbo协议</h5>
<ul>
<li>针对ABA阶段的性能提升</li>
<li>选一个k个成员的委员会，对k个集合进行共识</li>
</ul>
<h2 id="其他文档参考以及学习">其他文档参考以及学习</h2>
<p>这里贴一些有关区块链的文档：</p>
<p>[1]   <a target="_blank" rel="noopener" href="http://dcbcl.haut.edu.cn/ups/files/20210415/1618481195518620.pdf">中国工业和信息化部信息中心. 2018年中国区块链产业白皮书[EB/OL]. (2018-05)[2023-05-25].</a></p>
<p>[2]   百度搜索公司，百度区块链实验室，百度营销研究院. 百度区块链白皮书 v1.0. 2018-09.</p>
<p>[3]   腾讯FiT，腾讯研究院. 腾讯区块链方案白皮书. 2017-04.</p>
<p>[4]   京东. 京东区块链技术实践白皮书. 2018-03.</p>
<p>[5]   华为技术有限公司.华为区块链白皮书.2018-04.</p>
<h2 id="结束语">结束语</h2>
<p>至此，区块链的基础技术和相关概念已经介绍完毕，如果能完整学习下来的话，基本上也算是半个内行人了，后续会有更深入的技术介绍和前沿科学报告。</p>
<p>事实上我们可以发现，区块链并不局限于比特币或者以太坊这些应用，而是一种分布式管理思想的总和。作为人类社会中的一员，我们朴素地希望平等的互相信任，不希望被“统治”或者“垄断”。区块链提供了一个透明的手段，有望重构人与人之间的信任关系，试想一下，你不需要担心商家利用信息差抽取高额中介费，不需要担心水滴筹的捐款到不了真正需要的人手上，不需要担心你的食物中的食材来源其实是某个黑心工厂……这些就是做分布式信任的意义。</p>
<p>2008年至今，区块链技术在学术界已经成为了一个大的学术方向，并衍生出了扩容、隐私保护、数据共享、投票应用、跨链、攻击与安全等一系列小方向。我现在主要研究的是区块链数据共享方向，后续也会继续进行相关内容的学习。</p>
<blockquote>
<p>参考：</p>
<ol>
<li>袁勇, 王飞跃. 区块链技术发展现状与展望[J]. 自动化学报, 2016, 42(4): 481-494.</li>
<li>Zheng Z, Xie S, Dai H N, et al. Blockchain challenges and opportunities: A survey[J]. International journal of web and grid services, 2018, 14(4): 352-375.</li>
<li>《区块链理论与方法》</li>
<li>《精通区块链编程》</li>
<li>《区块链原理、设计与应用》</li>
</ol>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://Ann-103.github.io">Ann</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://ann-103.github.io/post/3643155828.html">https://ann-103.github.io/post/3643155828.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Ann-103.github.io" target="_blank">Ann-Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Blockchain/">Blockchain</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2024/11/14/OsgaF7GIC1NRlhe.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/1774397340.html" title="Git"><img class="cover" src="https://s2.loli.net/2024/11/14/hXzxaINeG7ucMwg.jpg" onerror="onerror=null;src='/img/loading.gif'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Git</div></div></a></div><div class="next-post pull-right"><a href="/post/1249121796.html" title="HTML+CSS速成"><img class="cover" src="https://s2.loli.net/2024/11/14/ezn2mqK7YOEsMca.jpg" onerror="onerror=null;src='/img/loading.gif'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">HTML+CSS速成</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/1783592341.html" title="Fabric"><img class="cover" src="https://s2.loli.net/2024/11/14/ezn2mqK7YOEsMca.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-06</div><div class="title">Fabric</div></div></a></div><div><a href="/post/3638070731.html" title="DID架构"><img class="cover" src="https://s2.loli.net/2024/11/22/HgvTujcKwQVEzUp.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-02</div><div class="title">DID架构</div></div></a></div><div><a href="/post/1858757970.html" title="fabric自定义网络搭建"><img class="cover" src="https://s2.loli.net/2024/12/05/SO3LhvBDmxZCou4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-07</div><div class="title">fabric自定义网络搭建</div></div></a></div><div><a href="/post/3364712731.html" title="zkSNARK 基础"><img class="cover" src="https://s2.loli.net/2024/12/05/SO3LhvBDmxZCou4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-06</div><div class="title">zkSNARK 基础</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ann</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">28</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Ann-103"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Ann-103" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ajw0822@mail.ustc.edu.cn" target="_blank" title="Em"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="iconfont icon-gonggao"></i><span>公告</span></div><div class="announcement_content">欢迎访问我的小破站 ❤</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">区块链技术基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">分布式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E8%AF%86%E8%BE%BE%E6%88%90"><span class="toc-number">1.1.2.</span> <span class="toc-text">共识达成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.3.</span> <span class="toc-text">其他问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81"><span class="toc-number">1.2.</span> <span class="toc-text">比特币</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%B7%E6%BA%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">起源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%BA%E5%9D%97%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">区块结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.3.</span> <span class="toc-text">交易结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E8%8A%B1%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">双花问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pow%E5%85%B1%E8%AF%86"><span class="toc-number">1.2.4.</span> <span class="toc-text">POW共识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E7%BD%91%E7%BB%9C"><span class="toc-number">1.2.5.</span> <span class="toc-text">比特币网络</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">网络节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%AD%E7%BB%A7%E7%BD%91%E7%BB%9C-relay-network"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">中继网络（Relay Network）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E4%B8%8E%E8%8A%82%E7%82%B9%E5%8F%91%E7%8E%B0"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">节点加入与节点发现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E9%92%B1%E5%8C%85"><span class="toc-number">1.2.6.</span> <span class="toc-text">比特币钱包</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E9%92%A5%E6%8A%80%E6%9C%AF"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">密钥技术</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E7%94%9F%E6%88%90"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">地址生成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.7.</span> <span class="toc-text">比特币工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E7%94%9F%E6%88%90"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">交易生成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E9%AA%8C%E8%AF%81"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">交易验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BA%E5%9D%97%E6%89%93%E5%8C%85"><span class="toc-number">1.2.7.3.</span> <span class="toc-text">区块打包</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A"><span class="toc-number">1.3.</span> <span class="toc-text">以太坊</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%B7%E6%BA%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">起源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">以太坊模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%A6%E6%88%B7%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">账户模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">系统架构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%BA%E5%9D%97%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.3.</span> <span class="toc-text">区块结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mpt"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">MPT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BF%80%E5%8A%B1%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%8F%94%E5%9D%97"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">激励机制与叔块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BA%E5%9D%97"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">区块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.4.</span> <span class="toc-text">交易结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E5%9B%9E%E6%89%A7"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">交易回执</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pos%E5%85%B1%E8%AF%86"><span class="toc-number">1.3.5.</span> <span class="toc-text">POS共识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%BD%91%E7%BB%9C"><span class="toc-number">1.3.6.</span> <span class="toc-text">以太坊网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A%E9%92%B1%E5%8C%85"><span class="toc-number">1.3.7.</span> <span class="toc-text">以太坊钱包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">1.3.8.</span> <span class="toc-text">以太坊虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A%E4%BA%A4%E6%98%93%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.9.</span> <span class="toc-text">以太坊交易流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%BA%E5%9D%97%E9%93%BE%E5%88%86%E7%B1%BB"><span class="toc-number">1.4.</span> <span class="toc-text">区块链分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">共识算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pow%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">POW算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pos%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.2.</span> <span class="toc-text">POS算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E4%BC%A0%E7%BB%9F%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7%E7%9A%84%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.3.</span> <span class="toc-text">基于传统分布式一致性的共识算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%85%B1%E8%AF%86"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">同步共识</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%9C%E5%8D%A0%E5%BA%ADpbft%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.3.1.1.</span> <span class="toc-text">拜占庭PBFT算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#paxos%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.3.1.2.</span> <span class="toc-text">Paxos算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#raft%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.3.1.3.</span> <span class="toc-text">Raft算法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%85%B1%E8%AF%86"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">异步共识</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#honeybadgerbft%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.5.3.2.1.</span> <span class="toc-text">HoneyBadgerBFT协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dumbo%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.5.3.2.2.</span> <span class="toc-text">Dumbo协议</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%96%87%E6%A1%A3%E5%8F%82%E8%80%83%E4%BB%A5%E5%8F%8A%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.6.</span> <span class="toc-text">其他文档参考以及学习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9D%9F%E8%AF%AD"><span class="toc-number">1.7.</span> <span class="toc-text">结束语</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Ann</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"> </i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="iconfont icon-triangleupfill"></i></button><button id="go-down" type="button" title="to_bottom" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="iconfont icon-triangledownfill"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'jlgkfToE73FxTz8kyHsmvdzb-gzGzoHsz',
      appKey: 'NN6nCIT47fGwz5Q1UyvFcGKP',
      avatar: 'retro',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="/js/custom.js"></script><script async data-pjax src="/js/waterfall/waterfall.js"></script><script src="/Ann/random.js"></script><script src="/js/snowflake.js"></script><script src="/js/hot.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.22.1/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.65.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js?v=4.13.0"></script></div></div></body></html>